<title>DnD Army Roll Tool</title>

<script src="https://cdn.jsdelivr.net/npm/brynja@3.2.0/cdn/brynja.js"></script>
<script src="https://unpkg.com/@olian/dice-roller@1.1.2/src/index.js"></script>

<h3>DnD Army Roll Tool</h3>
<div id="root"></div>


<script>
let state = {
  attackCount: 10,
  hitMod: 4,
  attackMode: 'normal',
  damageDie: 6,
  damageMod: 6,
  targetAc: 1,
  rolls: [],
}

const load = () => {
	const stateJSON = localStorage.getItem('state');
  if (stateJSON) {
  	state = JSON.parse(stateJSON);
  }
  console.log(state)
}

const save = () => {
	localStorage.setItem('state', JSON.stringify(state));
}


const update = () => {
  const hits = state.rolls.filter(([hit]) => hit > state.targetAc);
  brynja.render(_=>_
    .style({
      display: 'flex',
      flexDirection: 'column',
      gap: '4px',
      maxWidth: '320px'
    })
    .child('lable', _=>_
    	.style({
      	display: 'flex',
        justifyContent: 'space-between'
      })
      .text('Damage die: ')
      .child('input', _=>_
      	.prop('type', 'number')
        .value(state.damageDie)
        .on('change', ev => {
        	state.damageDie = parseInt(ev.target.value, 10);
        })
      )
    )
    .child('lable', _=>_
    	.style({
      	display: 'flex',
        justifyContent: 'space-between'
      })
      .text('Damage modifier: ')
      .child('input', _=>_
      	.prop('type', 'number')
        .value(state.damageMod)
        .on('change', ev => {
        	state.damageMod = parseInt(ev.target.value, 10);
        })
      )
    )
    .child('lable', _=>_
      .style({
      	display: 'flex',
        justifyContent: 'space-between'
      })
      .text('Hit modifier: ')
      .child('input', _=>_
      	.prop('type', 'number')
        .value(state.hitMod)
        .on('change', ev => {
          state.hitMod = parseInt(ev.target.value, 10);
        })
      )
    )
    .child('lable', _=>_
      .style({
      	display: 'flex',
        justifyContent: 'space-between'
      })
      .text('Number of attackars: ')
      .child('input', _=>_
      	.prop('type', 'number')
        .value(state.attackCount)
        .on('change', ev => {
          state.attackCount = parseInt(ev.target.value, 10);
        })
      )
    )
    .child('div', _=>_
      .style({
      	display: 'flex',
        justifyContent: 'space-between'
      })
      .child('lable', _=>_
      	.text('Normal')
      	.child('input', _=>_
          .prop('type', 'radio')
          .prop('name', 'attackMode')
          .value('normal')
          .on('change', ev => {
            state.attackMode = ev.target.value;
          })
          .when(state.attackMode === 'normal', _=>_
            .prop('checked', 'true')
          )
        )
      )
      .child('lable', _=>_
      	.text('Advantage')
      	.child('input', _=>_
          .prop('type', 'radio')
          .prop('name', 'attackMode')
          .value('advantage')
          .on('change', ev => {
            state.attackMode = ev.target.value;
          })
          .when(state.attackMode === 'advantage', _=>_
            .prop('checked', 'true')
          )
        )
      )
      .child('lable', _=>_
      	.text('Disadvantage')
      	.child('input', _=>_
          .prop('type', 'radio')
          .prop('name', 'attackMode')
          .value('disadvantage')
          .on('change', ev => {
            state.attackMode = ev.target.value;
          })
          .when(state.attackMode === 'disadvantage', _=>_
            .prop('checked', 'true')
          )
        )
      )
    )
    .child('input', _=>_
      .prop('type', 'button')
      .value('Roll')
      .on('click', () => {
      	state.targetAc = 1;
      	state.rolls = Array(state.attackCount).fill(0)
          .map(() => {
            const hitRolls = [
              rollDice(`d20 + ${state.hitMod}`).sum,
              rollDice(`d20 + ${state.hitMod}`).sum,
            ];
            return [
              state.attackMode === 'advantage' ? Math.max(...hitRolls) : 
              state.attackMode === 'disadvantage' ? Math.min(...hitRolls) :
              hitRolls[0],
              rollDice(`1d${state.damageDie} + ${state.damageMod}`).sum,
            ];
          })
          .sort((a,b) => a[0] - b[0]);
        update();
      })
    )
    .child('lable', _=>_
      .style({
      	display: 'flex',
        justifyContent: 'space-between'
      })
      .text('Target AC: ')
      .child('input', _=>_
      	.prop('type', 'number')
        .value(state.targetAc)
        .on('change', ev => {
          state.targetAc = parseInt(ev.target.value, 10);
          update();
        })
      )
    )
    .child('lable', _=>_
    	.text('Hits: ')
      .child('b', _=>_
      	.children('span', hits.length, (_,i)=>_
          .style({
            cursor: 'pointer',
            padding: '2px',
            border: '1px solid transparent',
            ':hover': {
            	border: '1px solid rgba(0, 0, 0, 0.2)'
            }
          })
          .text(hits[i][0])
          .on('click', ev => {
            state.targetAc = parseInt(ev.target.innerText, 10) - 1;
            update();
          })
        )
      )
    )
    .child('lable', _=>_
      .text('Damage: ')
      .child('b', _=>_
      	.text(`${hits.map(d => d[1]).reduce((a,b) => a+b, 0)} = ${hits.map(d => d[1]).join(' + ')}`)
      )
    )
  );
  save();
}

load();
update();
</script>
